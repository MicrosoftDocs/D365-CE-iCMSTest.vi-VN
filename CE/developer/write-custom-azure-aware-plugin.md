---
title: Write a custom Azure-aware plug-in (Developer Guide for Dynamics 365 for Customer Engagement apps) | MicrosoftDocs
description: The sample shows how plug-in code can be added to obtain the Azure service provider and initiate posting the execution context to the service bus by calling IExecutionContext).
ms.custom: ''
ms.date: 06/16/2018
ms.reviewer: ''
ms.service: crm-online
ms.suite: ''
ms.tgt_pltfrm: ''
ms.topic: article
applies_to:
- Dynamics 365 for Customer Engagement (online)
ms.assetid: 35d8e05c-245a-4eff-bc5f-3a4ee8ffcb46
caps.latest.revision: 30
author: JimDaly
ms.author: jdaly
manager: amyla
search.audienceType:
- developer
search.app:
- D365CE
ms.openlocfilehash: 146918ea43a61e1fbde0a4815215761614b9119f
ms.sourcegitcommit: 9f0efd59de16a6d9902fa372cb25fc0baf1c2838
ms.translationtype: HT
ms.contentlocale: vi-VN
ms.lasthandoff: 01/08/2019
ms.locfileid: "387715"
---
# <a name="write-a-custom-azure-aware-plug-in"></a><span data-ttu-id="76106-103">Write a custom Azure-aware plug-in</span><span class="sxs-lookup"><span data-stu-id="76106-103">Write a custom Azure-aware plug-in</span></span>

[!INCLUDE[](../includes/cc_applies_to_update_9_0_0.md)]

<span data-ttu-id="76106-104">Writing a plug-in that works with [!INCLUDE[pn_Windows_Azure](../includes/pn-windows-azure.md)] is similar to writing any other [!INCLUDE[pn_dynamics_crm](../includes/pn-dynamics-crm.md)] Customer Engagement plug-in.</span><span class="sxs-lookup"><span data-stu-id="76106-104">Writing a plug-in that works with [!INCLUDE[pn_Windows_Azure](../includes/pn-windows-azure.md)] is similar to writing any other [!INCLUDE[pn_dynamics_crm](../includes/pn-dynamics-crm.md)] Customer Engagement plug-in.</span></span> <span data-ttu-id="76106-105">However, in addition to invoking any desired web service methods, the plug-in must include code to initiate posting the execution context to the [!INCLUDE[windows_azure_service_bus](../includes/windows-azure-service-bus.md)].</span><span class="sxs-lookup"><span data-stu-id="76106-105">However, in addition to invoking any desired web service methods, the plug-in must include code to initiate posting the execution context to the [!INCLUDE[windows_azure_service_bus](../includes/windows-azure-service-bus.md)].</span></span>  
  
<a name="bkmk_design"></a>

## <a name="plug-in-design-considerations"></a><span data-ttu-id="76106-106">Plug-in design considerations</span><span class="sxs-lookup"><span data-stu-id="76106-106">Plug-in design considerations</span></span>  
<span data-ttu-id="76106-107">For a plug-in that executes synchronously, the recommended design is for the plug-in to send a message to [!INCLUDE[pn_Windows_Azure](../includes/pn-windows-azure.md)] for the purpose of retrieving information from a listener application or other external service.</span><span class="sxs-lookup"><span data-stu-id="76106-107">For a plug-in that executes synchronously, the recommended design is for the plug-in to send a message to [!INCLUDE[pn_Windows_Azure](../includes/pn-windows-azure.md)] for the purpose of retrieving information from a listener application or other external service.</span></span> <span data-ttu-id="76106-108">Use of a two-way or REST contract on the [!INCLUDE[windows_azure_service_bus](../includes/windows-azure-service-bus.md)] endpoint allows a data string to be returned to the plug-in.</span><span class="sxs-lookup"><span data-stu-id="76106-108">Use of a two-way or REST contract on the [!INCLUDE[windows_azure_service_bus](../includes/windows-azure-service-bus.md)] endpoint allows a data string to be returned to the plug-in.</span></span>  
  
<span data-ttu-id="76106-109">It is not recommended that a synchronous plug-in use the [!INCLUDE[windows_azure_service_bus](../includes/windows-azure-service-bus.md)] to update data with an external service.</span><span class="sxs-lookup"><span data-stu-id="76106-109">It is not recommended that a synchronous plug-in use the [!INCLUDE[windows_azure_service_bus](../includes/windows-azure-service-bus.md)] to update data with an external service.</span></span> <span data-ttu-id="76106-110">Problems can arise if the external service becomes unavailable or if there is a lot of data to update.</span><span class="sxs-lookup"><span data-stu-id="76106-110">Problems can arise if the external service becomes unavailable or if there is a lot of data to update.</span></span> <span data-ttu-id="76106-111">Synchronous plug-ins should execute fast and not hold up all logged in users of an organization while a lengthy operation is performed.</span><span class="sxs-lookup"><span data-stu-id="76106-111">Synchronous plug-ins should execute fast and not hold up all logged in users of an organization while a lengthy operation is performed.</span></span> <span data-ttu-id="76106-112">In addition, if a rollback of the current core operation that invoked the plug-in occurs, any data changes made by the plug-in are undone.</span><span class="sxs-lookup"><span data-stu-id="76106-112">In addition, if a rollback of the current core operation that invoked the plug-in occurs, any data changes made by the plug-in are undone.</span></span> <span data-ttu-id="76106-113">This could leave [!INCLUDE[pn_dynamics_crm](../includes/pn-dynamics-crm.md)] and an external service in an unsynchronized state.</span><span class="sxs-lookup"><span data-stu-id="76106-113">This could leave [!INCLUDE[pn_dynamics_crm](../includes/pn-dynamics-crm.md)] and an external service in an unsynchronized state.</span></span>  
  
<span data-ttu-id="76106-114">Note that it is possible for synchronous registered plug-ins to post the execution context to the [!INCLUDE[windows_azure_service_bus](../includes/windows-azure-service-bus.md)].</span><span class="sxs-lookup"><span data-stu-id="76106-114">Note that it is possible for synchronous registered plug-ins to post the execution context to the [!INCLUDE[windows_azure_service_bus](../includes/windows-azure-service-bus.md)].</span></span>  
  
<a name="bkmk_writing"></a>
  
## <a name="write-the-plug-in-code"></a><span data-ttu-id="76106-115">Write the plug-in code</span><span class="sxs-lookup"><span data-stu-id="76106-115">Write the plug-in code</span></span> 
 
<span data-ttu-id="76106-116">In the following sample plug-in code has been added to obtain the [!INCLUDE[pn_Windows_Azure](../includes/pn-windows-azure.md)] service provider and initiate posting the execution context to the service bus by calling <xref:Microsoft.Xrm.Sdk.IServiceEndpointNotificationService.Execute(Microsoft.Xrm.Sdk.EntityReference,Microsoft.Xrm.Sdk.IExecutionContext)>.</span><span class="sxs-lookup"><span data-stu-id="76106-116">In the following sample plug-in code has been added to obtain the [!INCLUDE[pn_Windows_Azure](../includes/pn-windows-azure.md)] service provider and initiate posting the execution context to the service bus by calling <xref:Microsoft.Xrm.Sdk.IServiceEndpointNotificationService.Execute(Microsoft.Xrm.Sdk.EntityReference,Microsoft.Xrm.Sdk.IExecutionContext)>.</span></span> <span data-ttu-id="76106-117">Tracing code has been added to facilitate debugging of the plug-in because the plug-in must run in the sandbox.</span><span class="sxs-lookup"><span data-stu-id="76106-117">Tracing code has been added to facilitate debugging of the plug-in because the plug-in must run in the sandbox.</span></span>  

> [!NOTE]
> <span data-ttu-id="76106-118">The `serviceEndpointId` passed into the constructor in this code is the one you get from creating a service endpoint as described in [Walkthrough: Configure Azure (SAS) for integration with Customer Engagement](walkthrough-configure-azure-sas-integration.md)</span><span class="sxs-lookup"><span data-stu-id="76106-118">The `serviceEndpointId` passed into the constructor in this code is the one you get from creating a service endpoint as described in [Walkthrough: Configure Azure (SAS) for integration with Customer Engagement](walkthrough-configure-azure-sas-integration.md)</span></span>
>
> <span data-ttu-id="76106-119">You can query available service endpoints for your environment using a `GET` request to Web API using your browser with a query like this: *`[organization Uri]`*`/api/data/v9.0/serviceendpoints?$select=name,description,serviceendpointid`</span><span class="sxs-lookup"><span data-stu-id="76106-119">You can query available service endpoints for your environment using a `GET` request to Web API using your browser with a query like this: *`[organization Uri]`*`/api/data/v9.0/serviceendpoints?$select=name,description,serviceendpointid`</span></span>
  
[!code-csharp[WindowsAzure#SandboxPlugin](../snippets/csharp/CRMV8/windowsazure/cs/sandboxplugin.cs#sandboxplugin)]  
  
<span data-ttu-id="76106-120">In your plug-in code, you can update the writeable data in the context before initiating the post.</span><span class="sxs-lookup"><span data-stu-id="76106-120">In your plug-in code, you can update the writeable data in the context before initiating the post.</span></span> <span data-ttu-id="76106-121">For example, you can add a key/value pair to the shared variables in the context.</span><span class="sxs-lookup"><span data-stu-id="76106-121">For example, you can add a key/value pair to the shared variables in the context.</span></span>  
  
<a name="bkmk_registration"></a>

## <a name="plug-in-registration"></a><span data-ttu-id="76106-122">Plug-in registration</span><span class="sxs-lookup"><span data-stu-id="76106-122">Plug-in registration</span></span>

<span data-ttu-id="76106-123">There are a few restrictions when you register a [!INCLUDE[pn_Windows_Azure](../includes/pn-windows-azure.md)] aware custom plug-in.</span><span class="sxs-lookup"><span data-stu-id="76106-123">There are a few restrictions when you register a [!INCLUDE[pn_Windows_Azure](../includes/pn-windows-azure.md)] aware custom plug-in.</span></span> <span data-ttu-id="76106-124">The plug-in must be registered to execute in the sandbox.</span><span class="sxs-lookup"><span data-stu-id="76106-124">The plug-in must be registered to execute in the sandbox.</span></span> <span data-ttu-id="76106-125">Because of this, the plug-in is limited to calling <xref:Microsoft.Xrm.Sdk.IOrganizationService> methods, [!INCLUDE[pn_Windows_Azure](../includes/pn-windows-azure.md)] solution methods, or accessing a network using a web client.</span><span class="sxs-lookup"><span data-stu-id="76106-125">Because of this, the plug-in is limited to calling <xref:Microsoft.Xrm.Sdk.IOrganizationService> methods, [!INCLUDE[pn_Windows_Azure](../includes/pn-windows-azure.md)] solution methods, or accessing a network using a web client.</span></span> <span data-ttu-id="76106-126">No other external access, such as access to a local file system, is allowed.</span><span class="sxs-lookup"><span data-stu-id="76106-126">No other external access, such as access to a local file system, is allowed.</span></span>  
  
<span data-ttu-id="76106-127">For a plug-in registered to execute in asynchronous mode, this also means that the order of plug-in execution compared to other asynchronous plug-ins is not guaranteed.</span><span class="sxs-lookup"><span data-stu-id="76106-127">For a plug-in registered to execute in asynchronous mode, this also means that the order of plug-in execution compared to other asynchronous plug-ins is not guaranteed.</span></span> <span data-ttu-id="76106-128">In addition, asynchronous plug-ins always execute after the [!INCLUDE[pn_dynamics_crm](../includes/pn-dynamics-crm.md)] core operation.</span><span class="sxs-lookup"><span data-stu-id="76106-128">In addition, asynchronous plug-ins always execute after the [!INCLUDE[pn_dynamics_crm](../includes/pn-dynamics-crm.md)] core operation.</span></span>  
  
<a name="bkmk_failure"></a>
 
## <a name="handle-a-failed-service-bus-post"></a><span data-ttu-id="76106-129">Handle a failed service bus post</span><span class="sxs-lookup"><span data-stu-id="76106-129">Handle a failed service bus post</span></span>

<span data-ttu-id="76106-130">The expected behavior from a failed service bus post is dependent on whether the plug-in was registered for synchronous or asynchronous execution.</span><span class="sxs-lookup"><span data-stu-id="76106-130">The expected behavior from a failed service bus post is dependent on whether the plug-in was registered for synchronous or asynchronous execution.</span></span> <span data-ttu-id="76106-131">For asynchronous plug-ins, the system job that actually posts the execution context to the service bus will retry the post.</span><span class="sxs-lookup"><span data-stu-id="76106-131">For asynchronous plug-ins, the system job that actually posts the execution context to the service bus will retry the post.</span></span> <span data-ttu-id="76106-132">For a synchronous registered plug-in, an exception is returned.</span><span class="sxs-lookup"><span data-stu-id="76106-132">For a synchronous registered plug-in, an exception is returned.</span></span> [!INCLUDE[proc_more_information](../includes/proc-more-information.md)] <span data-ttu-id="76106-133">[Management and Notification of Run-time Errors](azure-integration.md#bkmk_management)</span><span class="sxs-lookup"><span data-stu-id="76106-133">[Management and Notification of Run-time Errors](azure-integration.md#bkmk_management)</span></span>  
  
> [!IMPORTANT]
>  <span data-ttu-id="76106-134">For asynchronous registered plug-ins only, when the asynchronous job that posts to the [!INCLUDE[windows_azure_service_bus](../includes/windows-azure-service-bus.md)] is retried after a post failure, the entire plug-in logic is executed again.</span><span class="sxs-lookup"><span data-stu-id="76106-134">For asynchronous registered plug-ins only, when the asynchronous job that posts to the [!INCLUDE[windows_azure_service_bus](../includes/windows-azure-service-bus.md)] is retried after a post failure, the entire plug-in logic is executed again.</span></span> <span data-ttu-id="76106-135">Because of this, don’t add any other logic to the custom [!INCLUDE[pn_Windows_Azure](../includes/pn-windows-azure.md)] aware plug-in other than just modifying the context and posting to the service bus.</span><span class="sxs-lookup"><span data-stu-id="76106-135">Because of this, don’t add any other logic to the custom [!INCLUDE[pn_Windows_Azure](../includes/pn-windows-azure.md)] aware plug-in other than just modifying the context and posting to the service bus.</span></span>  
  
<span data-ttu-id="76106-136">For a plug-in registered to execute asynchronously, the <xref:Microsoft.Xrm.Sdk.RemoteExecutionContext> contained in the body of the message that is sent over the service bus includes a <xref:Microsoft.Xrm.Sdk.RemoteExecutionContext.OperationId> property and a <xref:Microsoft.Xrm.Sdk.RemoteExecutionContext.OperationCreatedOn> property.</span><span class="sxs-lookup"><span data-stu-id="76106-136">For a plug-in registered to execute asynchronously, the <xref:Microsoft.Xrm.Sdk.RemoteExecutionContext> contained in the body of the message that is sent over the service bus includes a <xref:Microsoft.Xrm.Sdk.RemoteExecutionContext.OperationId> property and a <xref:Microsoft.Xrm.Sdk.RemoteExecutionContext.OperationCreatedOn> property.</span></span> <span data-ttu-id="76106-137">These properties contain the same data as the `AsyncOperationId` and `CreatedOn` attributes of the related System Job (`AsyncOperation`) record.</span><span class="sxs-lookup"><span data-stu-id="76106-137">These properties contain the same data as the `AsyncOperationId` and `CreatedOn` attributes of the related System Job (`AsyncOperation`) record.</span></span> <span data-ttu-id="76106-138">These additional properties facilitate sequencing and duplicate detection if the [!INCLUDE[windows_azure_service_bus](../includes/windows-azure-service-bus.md)] post must be retried.</span><span class="sxs-lookup"><span data-stu-id="76106-138">These additional properties facilitate sequencing and duplicate detection if the [!INCLUDE[windows_azure_service_bus](../includes/windows-azure-service-bus.md)] post must be retried.</span></span>  
  
### <a name="see-also"></a><span data-ttu-id="76106-139">Xem thêm</span><span class="sxs-lookup"><span data-stu-id="76106-139">See also</span></span>

[<span data-ttu-id="76106-140">Azure Extensions for Dynamics 365 for Customer Engagement apps</span><span class="sxs-lookup"><span data-stu-id="76106-140">Azure Extensions for Dynamics 365 for Customer Engagement apps</span></span>](azure-extensions.md)<br />
[<span data-ttu-id="76106-141">Send Dynamics 365 for Customer Engagement apps Data over the Microsoft Azure Service Bus</span><span class="sxs-lookup"><span data-stu-id="76106-141">Send Dynamics 365 for Customer Engagement apps Data over the Microsoft Azure Service Bus</span></span>](work-data-azure-solution.md)<br />
[<span data-ttu-id="76106-142">Write a Plug-In</span><span class="sxs-lookup"><span data-stu-id="76106-142">Write a Plug-In</span></span>](write-plugin.md)<br />
[<span data-ttu-id="76106-143">Plug-in Isolation, Trust, and the Disallowed List</span><span class="sxs-lookup"><span data-stu-id="76106-143">Plug-in Isolation, Trust, and the Disallowed List</span></span>](plugin-isolation-trusts-statistics.md)<br />
[<span data-ttu-id="76106-144">Event Execution Pipeline</span><span class="sxs-lookup"><span data-stu-id="76106-144">Event Execution Pipeline</span></span>](event-execution-pipeline.md)<br />
[<span data-ttu-id="76106-145">Register and Deploy Plug-Ins</span><span class="sxs-lookup"><span data-stu-id="76106-145">Register and Deploy Plug-Ins</span></span>](register-deploy-plugins.md)
