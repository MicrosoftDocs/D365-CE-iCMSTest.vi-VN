---
title: Reduce potential data loss using optimistic concurrency (Developer Guide for Dynamics 365 for Customer Engagement)| MicrosoftDocs
description: Learn how to reduce potential data loss when two or more update or delete operations on the same piece of data happen at the same time using optimistic concurrency
ms.custom: ''
ms.date: 10/31/2017
ms.reviewer: ''
ms.service: crm-online
ms.suite: ''
ms.tgt_pltfrm: ''
ms.topic: article
applies_to:
- Dynamics 365 for Customer Engagement (online)
ms.assetid: 0eb0167c-e312-4c6f-8a3c-760a2e73c0ff
caps.latest.revision: 17
author: JimDaly
ms.author: jdaly
manager: amyla
search.audienceType:
- developer
search.app:
- D365CE
ms.openlocfilehash: 498a971d72404e9a2a2fa92cd9eb1d3fe908595b
ms.sourcegitcommit: 9f0efd59de16a6d9902fa372cb25fc0baf1c2838
ms.translationtype: HT
ms.contentlocale: vi-VN
ms.lasthandoff: 01/08/2019
ms.locfileid: "388097"
---
# <a name="reduce-potential-data-loss-using-optimistic-concurrency"></a><span data-ttu-id="4050d-103">Reduce potential data loss using optimistic concurrency</span><span class="sxs-lookup"><span data-stu-id="4050d-103">Reduce potential data loss using optimistic concurrency</span></span>

[!INCLUDE[](../../includes/cc_applies_to_update_9_0_0.md)]

<span data-ttu-id="4050d-104">On a multi-threaded and multi-user system like [!INCLUDE[pn_dynamics_crm](../../includes/pn-dynamics-crm.md)] apps, operations and data changes often happen in parallel.</span><span class="sxs-lookup"><span data-stu-id="4050d-104">On a multi-threaded and multi-user system like [!INCLUDE[pn_dynamics_crm](../../includes/pn-dynamics-crm.md)] apps, operations and data changes often happen in parallel.</span></span> <span data-ttu-id="4050d-105">A problem arises when two or more update or delete operations on the same piece of data happen at the same time.</span><span class="sxs-lookup"><span data-stu-id="4050d-105">A problem arises when two or more update or delete operations on the same piece of data happen at the same time.</span></span> <span data-ttu-id="4050d-106">This situation could potentially result in data loss.</span><span class="sxs-lookup"><span data-stu-id="4050d-106">This situation could potentially result in data loss.</span></span> <span data-ttu-id="4050d-107">Provided in this SDK release is the ability for your applications to detect whether an entity record has changed on the server in the time between when your application retrieved the record and when it tries to update or delete that record.</span><span class="sxs-lookup"><span data-stu-id="4050d-107">Provided in this SDK release is the ability for your applications to detect whether an entity record has changed on the server in the time between when your application retrieved the record and when it tries to update or delete that record.</span></span>  
  
 <span data-ttu-id="4050d-108">Optimistic concurrency is supported on all out-of-box entities enabled for offline sync and all custom entities.</span><span class="sxs-lookup"><span data-stu-id="4050d-108">Optimistic concurrency is supported on all out-of-box entities enabled for offline sync and all custom entities.</span></span> <span data-ttu-id="4050d-109">You can determine if an entity supports optimistic concurrency by retrieving the entity’s metadata through an SDK call, or by viewing the metadata using the Metadata Browser, and check if the attribute **IsOptimisticConcurrencyEnabled** is set to `true`.</span><span class="sxs-lookup"><span data-stu-id="4050d-109">You can determine if an entity supports optimistic concurrency by retrieving the entity’s metadata through an SDK call, or by viewing the metadata using the Metadata Browser, and check if the attribute **IsOptimisticConcurrencyEnabled** is set to `true`.</span></span> <span data-ttu-id="4050d-110">For custom entities, this property is set to `true` by default.</span><span class="sxs-lookup"><span data-stu-id="4050d-110">For custom entities, this property is set to `true` by default.</span></span> [!INCLUDE[metadata_browser](../../includes/metadata-browser.md)]  
  
<a name="bkmk_enable"></a>   
## <a name="enable-optimistic-concurrency"></a><span data-ttu-id="4050d-111">Enable optimistic concurrency</span><span class="sxs-lookup"><span data-stu-id="4050d-111">Enable optimistic concurrency</span></span>  
 <span data-ttu-id="4050d-112">You can enable optimistic concurrency checking behavior when executing an <xref:Microsoft.Xrm.Sdk.Messages.UpdateRequest> by setting the <xref:Microsoft.Xrm.Sdk.Messages.UpdateRequest.ConcurrencyBehavior> property of the request to <xref:Microsoft.Xrm.Sdk.ConcurrencyBehavior.IfRowVersionMatches>.</span><span class="sxs-lookup"><span data-stu-id="4050d-112">You can enable optimistic concurrency checking behavior when executing an <xref:Microsoft.Xrm.Sdk.Messages.UpdateRequest> by setting the <xref:Microsoft.Xrm.Sdk.Messages.UpdateRequest.ConcurrencyBehavior> property of the request to <xref:Microsoft.Xrm.Sdk.ConcurrencyBehavior.IfRowVersionMatches>.</span></span> <span data-ttu-id="4050d-113">Similarly, for a <xref:Microsoft.Xrm.Sdk.Messages.DeleteRequest>, you would set the <xref:Microsoft.Xrm.Sdk.Messages.DeleteRequest.ConcurrencyBehavior> property.</span><span class="sxs-lookup"><span data-stu-id="4050d-113">Similarly, for a <xref:Microsoft.Xrm.Sdk.Messages.DeleteRequest>, you would set the <xref:Microsoft.Xrm.Sdk.Messages.DeleteRequest.ConcurrencyBehavior> property.</span></span>  
  
 <span data-ttu-id="4050d-114">When using the organization service context to make data changes, set <xref:Microsoft.Xrm.Sdk.Client.OrganizationServiceContext.ConcurrencyBehavior> on the <xref:Microsoft.Xrm.Sdk.Client.OrganizationServiceContext> object.</span><span class="sxs-lookup"><span data-stu-id="4050d-114">When using the organization service context to make data changes, set <xref:Microsoft.Xrm.Sdk.Client.OrganizationServiceContext.ConcurrencyBehavior> on the <xref:Microsoft.Xrm.Sdk.Client.OrganizationServiceContext> object.</span></span> <span data-ttu-id="4050d-115">This value will be passed through to all of the **UpdateRequest** and **DeleteRequest** messages used by the **OrganizationServiceContext** when <xref:Microsoft.Xrm.Sdk.Client.OrganizationServiceContext.SaveChanges> is called.</span><span class="sxs-lookup"><span data-stu-id="4050d-115">This value will be passed through to all of the **UpdateRequest** and **DeleteRequest** messages used by the **OrganizationServiceContext** when <xref:Microsoft.Xrm.Sdk.Client.OrganizationServiceContext.SaveChanges> is called.</span></span>  
  
 <span data-ttu-id="4050d-116">Optimistic concurrency behavior can only be set through an SDK call.</span><span class="sxs-lookup"><span data-stu-id="4050d-116">Optimistic concurrency behavior can only be set through an SDK call.</span></span> <span data-ttu-id="4050d-117">There is presently no setting for it in a form of the Web application.</span><span class="sxs-lookup"><span data-stu-id="4050d-117">There is presently no setting for it in a form of the Web application.</span></span>  
  
<a name="bkmk_update"></a>   
## <a name="update-or-delete-a-record"></a><span data-ttu-id="4050d-118">Update or delete a record</span><span class="sxs-lookup"><span data-stu-id="4050d-118">Update or delete a record</span></span>  
 <span data-ttu-id="4050d-119">After retrieving an entity record, access the <xref:Microsoft.Xrm.Sdk.Entity.RowVersion> attribute to obtain the current version of that record.</span><span class="sxs-lookup"><span data-stu-id="4050d-119">After retrieving an entity record, access the <xref:Microsoft.Xrm.Sdk.Entity.RowVersion> attribute to obtain the current version of that record.</span></span> <span data-ttu-id="4050d-120">In the entity object you use as the <xref:Microsoft.Xrm.Sdk.Messages.UpdateRequest.Target> in the <xref:Microsoft.Xrm.Sdk.Messages.UpdateRequest>, set the <xref:Microsoft.Xrm.Sdk.Entity.RowVersion> property to the same value from the retrieved record and execute the request.</span><span class="sxs-lookup"><span data-stu-id="4050d-120">In the entity object you use as the <xref:Microsoft.Xrm.Sdk.Messages.UpdateRequest.Target> in the <xref:Microsoft.Xrm.Sdk.Messages.UpdateRequest>, set the <xref:Microsoft.Xrm.Sdk.Entity.RowVersion> property to the same value from the retrieved record and execute the request.</span></span> <span data-ttu-id="4050d-121">Similarly, in the entity reference object you use as the <xref:Microsoft.Xrm.Sdk.Messages.DeleteRequest.Target> in the <xref:Microsoft.Xrm.Sdk.Messages.DeleteRequest>, set the <xref:Microsoft.Xrm.Sdk.EntityReference.RowVersion> property to the same row version value from the retrieved record and execute the request.</span><span class="sxs-lookup"><span data-stu-id="4050d-121">Similarly, in the entity reference object you use as the <xref:Microsoft.Xrm.Sdk.Messages.DeleteRequest.Target> in the <xref:Microsoft.Xrm.Sdk.Messages.DeleteRequest>, set the <xref:Microsoft.Xrm.Sdk.EntityReference.RowVersion> property to the same row version value from the retrieved record and execute the request.</span></span>  
  
 <span data-ttu-id="4050d-122">If the entity passed to the **UpdateRequest** contains related entities, the same behavior is applied to all update operations using the row versions supplied with each individual entity.</span><span class="sxs-lookup"><span data-stu-id="4050d-122">If the entity passed to the **UpdateRequest** contains related entities, the same behavior is applied to all update operations using the row versions supplied with each individual entity.</span></span>  
  
 <span data-ttu-id="4050d-123">When the request is received by the platform, a comparison of the current entity record row version and the row version in the request is performed.</span><span class="sxs-lookup"><span data-stu-id="4050d-123">When the request is received by the platform, a comparison of the current entity record row version and the row version in the request is performed.</span></span> <span data-ttu-id="4050d-124">If the row versions match and <xref:Microsoft.Xrm.Sdk.Messages.UpdateRequest.ConcurrencyBehavior> is set to <xref:Microsoft.Xrm.Sdk.ConcurrencyBehavior.IfRowVersionMatches>, the operation succeeds.</span><span class="sxs-lookup"><span data-stu-id="4050d-124">If the row versions match and <xref:Microsoft.Xrm.Sdk.Messages.UpdateRequest.ConcurrencyBehavior> is set to <xref:Microsoft.Xrm.Sdk.ConcurrencyBehavior.IfRowVersionMatches>, the operation succeeds.</span></span> <span data-ttu-id="4050d-125">Otherwise, a fault exception is returned.</span><span class="sxs-lookup"><span data-stu-id="4050d-125">Otherwise, a fault exception is returned.</span></span>  
  
<a name="bkmk_handle"></a>   
## <a name="handle-exceptions"></a><span data-ttu-id="4050d-126">Handle exceptions</span><span class="sxs-lookup"><span data-stu-id="4050d-126">Handle exceptions</span></span>  
 <span data-ttu-id="4050d-127">There are several error conditions that can be returned in a [FaultException](https://msdn.microsoft.com/library/ms576199\(v=vs.110\).aspx)\<<xref:Microsoft.Xrm.Sdk.OrganizationServiceFault>> from the Web service call when using optimistic concurrency.</span><span class="sxs-lookup"><span data-stu-id="4050d-127">There are several error conditions that can be returned in a [FaultException](https://msdn.microsoft.com/library/ms576199\(v=vs.110\).aspx)\<<xref:Microsoft.Xrm.Sdk.OrganizationServiceFault>> from the Web service call when using optimistic concurrency.</span></span>  
  
- <span data-ttu-id="4050d-128">**ConcurrencyVersionMismatch** (code=-2147088254)</span><span class="sxs-lookup"><span data-stu-id="4050d-128">**ConcurrencyVersionMismatch** (code=-2147088254)</span></span>  
  
     <span data-ttu-id="4050d-129">When a row version is provided and the **IfVersionMatches** behavior is indicated, if the existing record’s version does not match the row version provided in the request, a fault is returned.</span><span class="sxs-lookup"><span data-stu-id="4050d-129">When a row version is provided and the **IfVersionMatches** behavior is indicated, if the existing record’s version does not match the row version provided in the request, a fault is returned.</span></span>  
  
- <span data-ttu-id="4050d-130">**ConcurrencyVersionNotProvided** (code= -2147088253</span><span class="sxs-lookup"><span data-stu-id="4050d-130">**ConcurrencyVersionNotProvided** (code= -2147088253</span></span>  
  
     <span data-ttu-id="4050d-131">When the **IfVersionMatches** behavior is indicated, and no value for row version is provided, a fault is returned.</span><span class="sxs-lookup"><span data-stu-id="4050d-131">When the **IfVersionMatches** behavior is indicated, and no value for row version is provided, a fault is returned.</span></span>  
  
- <span data-ttu-id="4050d-132">**OptimisticConcurrencyNotEnabled** (code=-2147088243)</span><span class="sxs-lookup"><span data-stu-id="4050d-132">**OptimisticConcurrencyNotEnabled** (code=-2147088243)</span></span>  
  
     <span data-ttu-id="4050d-133">When the **IfVersionMatches** behavior is indicated on an update to an entity, and where optimistic concurrency isn’t enabled, a fault is returned.</span><span class="sxs-lookup"><span data-stu-id="4050d-133">When the **IfVersionMatches** behavior is indicated on an update to an entity, and where optimistic concurrency isn’t enabled, a fault is returned.</span></span>  
  
  <span data-ttu-id="4050d-134">You can check the [Code](https://msdn.microsoft.com/library/system.servicemodel.faultexception.code\(v=vs.110\).aspx) property of the returned fault to determine if the fault is related to optimistic concurrency.</span><span class="sxs-lookup"><span data-stu-id="4050d-134">You can check the [Code](https://msdn.microsoft.com/library/system.servicemodel.faultexception.code\(v=vs.110\).aspx) property of the returned fault to determine if the fault is related to optimistic concurrency.</span></span> <span data-ttu-id="4050d-135">The codes for the error conditions that were shown previously were obtained from the ErrorCodes.cs helper code.</span><span class="sxs-lookup"><span data-stu-id="4050d-135">The codes for the error conditions that were shown previously were obtained from the ErrorCodes.cs helper code.</span></span>  
  
### <a name="see-also"></a><span data-ttu-id="4050d-136">Xem thêm</span><span class="sxs-lookup"><span data-stu-id="4050d-136">See also</span></span>  
 <span data-ttu-id="4050d-137">[Extend Dynamics 365 for Customer Engagement apps on the server](../extend-dynamics-365-server.md) </span><span class="sxs-lookup"><span data-stu-id="4050d-137">[Extend Dynamics 365 for Customer Engagement apps on the server](../extend-dynamics-365-server.md) </span></span>  
 [<span data-ttu-id="4050d-138">Sample: Use optimistic concurrency with update and delete operations</span><span class="sxs-lookup"><span data-stu-id="4050d-138">Sample: Use optimistic concurrency with update and delete operations</span></span>](sample-use-optimistic-concurrency-update-delete-operations.md)
